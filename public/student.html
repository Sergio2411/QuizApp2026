<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Examen - MiQuizOnline</title>
    <!-- Favicons y Manifest -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="shortcut icon" href="/favicon.ico">
    <!-- Estilos y Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <!-- Configuraci√≥n de MathJax -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true
        },
        options: {
          skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
        }
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>
<body class="h-full text-slate-800">

    <!-- Indicador de estado sin conexi√≥n -->
    <div id="offline-indicator" class="hidden fixed top-0 left-0 right-0 p-2 bg-yellow-500 text-black text-center font-semibold z-50">
        Conexi√≥n perdida. Reintentando...
    </div>

    <!-- Contenedores para efectos visuales (fuera del flujo principal) -->
    <div id="confetti-container" class="absolute top-0 left-0 w-full h-full pointer-events-none z-40"></div>
    <div id="animation-overlay" class="fixed inset-0 pointer-events-none z-50"></div>

    <!-- Contenedor principal sem√°ntico -->
    <main class="w-full h-full flex items-center justify-center p-2 sm:p-4">
        <div id="main-container" class="w-full h-full bg-white transition-all duration-300 flex flex-col max-w-4xl rounded-xl shadow-lg overflow-hidden">
            
            <!-- Pantalla de Carga Inicial -->
            <section id="loading-screen" class="screen active flex-grow flex-col justify-center items-center p-6">
                <div class="w-full max-w-sm text-center">
                    <p class="font-semibold text-slate-600">Cargando...</p>
                </div>
            </section>

            <!-- Pantalla de Login del Estudiante -->
            <section id="student-login-screen" class="screen hidden fade-in flex-grow flex-col justify-center items-center p-6">
                <a href="/index.html" id="student-back-btn" class="absolute top-4 left-4 text-slate-600 py-2 px-4 rounded-lg hover:bg-slate-100" aria-label="Volver a la p√°gina principal">&larr; Volver</a>
                <div class="w-full max-w-sm">
                    <h1 class="text-2xl font-bold text-center mb-4">Bienvenido</h1>
                    <p class="text-slate-600 text-center mb-6">Elige c√≥mo quieres unirte.</p>
                    <div class="space-y-4">
                        <button id="google-login-btn" class="w-full bg-white border border-slate-300 text-slate-700 font-bold py-3 rounded-lg hover:bg-slate-100 transition-colors flex items-center justify-center gap-2">
                            <img src="https://www.google.com/favicon.ico" alt="Google icon" class="w-5 h-5"> Ingresar con Google
                        </button>
                        <p class="text-center my-2 text-slate-500 font-semibold">o</p>
                        <div id="guest-login-form">
                            <input type="text" id="student-name" placeholder="Escribe tu nombre o apodo" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none mb-4">
                            <button id="guest-login-btn" class="w-full bg-slate-600 text-white font-bold py-3 rounded-lg hover:bg-slate-700 transition-colors">Jugar como Invitado</button>
                        </div>
                    </div>
                    <p id="student-error" class="text-red-500 text-center mt-4 text-sm font-medium h-5"></p>
                </div>
            </section>

            <!-- Pantalla para Ingresar C√≥digo (Post-Login) -->
            <section id="enter-code-screen" class="screen hidden fade-in flex-grow flex-col justify-center items-center p-6">
                <div class="w-full max-w-sm">
                    <button id="logout-btn" class="absolute top-4 right-4 text-sm text-slate-600 py-2 px-3 rounded-lg hover:bg-slate-100">Salir</button>
                    <h1 id="enter-code-greeting" class="text-2xl font-bold text-center mb-4">¬°Hola!</h1>
                    <p class="text-slate-600 text-center mb-6">Ingresa el c√≥digo del examen para unirte a la partida.</p>
                    <div class="space-y-4">
                        <div>
                            <label for="enter-quiz-code" class="sr-only">C√≥digo de 4 d√≠gitos</label>
                            <input type="text" id="enter-quiz-code" placeholder="C√≥digo de 4 d√≠gitos" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" maxlength="4">
                        </div>
                        <button id="join-game-btn" class="w-full bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 transition-colors">Unirse al Juego</button>
                        <button id="collections-btn" class="w-full bg-amber-500 text-white font-bold py-3 rounded-lg hover:bg-amber-600 transition-colors hidden">üèÜ Mis Colecciones</button>
                    </div>
                    <p id="enter-code-error" class="text-red-500 text-center mt-4 text-sm font-medium h-5"></p>
                </div>
            </section>

             <!-- Pantalla de Colecciones -->
            <section id="collections-screen" class="screen hidden p-6 flex flex-col h-full">
                <header class="flex justify-between items-center mb-4 flex-shrink-0">
                    <h1 class="text-2xl font-bold">Mis Medallas</h1>
                    <button id="collections-back-btn" class="text-slate-600 py-2 px-4 rounded-lg hover:bg-slate-100">Volver</button>
                </header>
                <div id="medals-container" class="scrollable-content flex-grow grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <!-- Medallas se insertan aqu√≠ -->
                </div>
            </section>


            <!-- Pantalla de Selecci√≥n de Avatar -->
            <section id="avatar-selection-screen" class="screen hidden flex-grow flex-col justify-center items-center p-6">
                <div class="w-full max-w-lg text-center">
                    <h1 class="text-2xl font-bold mb-2">¬°Elige tu Avatar!</h1>
                    <p class="text-slate-600 mb-6">Este emoji te representar√° en la monta√±a.</p>
                    <div id="emoji-selector" class="grid grid-cols-8 gap-2 bg-slate-100 p-4 rounded-lg mb-6">
                        <!-- Emojis se insertan aqu√≠ -->
                    </div>
                    <input type="hidden" id="selected-player-emoji">
                    <button id="confirm-avatar-btn" class="w-full bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 transition-colors">Confirmar y Jugar</button>
                    <p id="avatar-error" class="text-red-500 text-center mt-4 text-sm font-medium h-5"></p>
                </div>
            </section>

            <!-- Pantalla del Examen -->
            <section id="quiz-screen" class="screen hidden flex-col h-full p-4 md:p-6">
                <header id="quiz-header" class="flex justify-between items-center mb-4 flex-shrink-0">
                     <div id="mastery-progress-container" class="hidden w-full bg-slate-200 rounded-full h-6">
                        <div id="mastery-progress-bar" class="bg-green-500 h-6 rounded-full text-right pr-2 text-white font-bold transition-all duration-500 ease-out"></div>
                        <span id="mastery-progress-text" class="absolute w-full text-center text-sm font-semibold text-slate-700 self-center"></span>
                    </div>
                    <div id="student-hearts-display"></div>
                    <span id="progress-indicator" class="ml-4 text-sm font-medium bg-slate-200 text-slate-700 px-3 py-1 rounded-full whitespace-nowrap"></span>
                </header>
                <div id="question-container" class="fade-in mb-4 flex-shrink-0 text-center">
                    <img id="question-image" alt="Imagen de la pregunta" class="max-w-full mx-auto mb-4 rounded-lg h-auto hidden" />
                    <p id="question-text" class="text-xl md:text-2xl font-medium"></p>
                </div>
                <div id="options-container" class="flex-grow min-h-0 w-full"></div>
            </section>

            <!-- Pantalla Final (Resultados) -->
            <section id="end-screen" class="screen hidden text-center fade-in p-4 md:p-6 flex flex-col h-full">
                <div id="waiting-view" class="m-auto w-full max-w-lg">
                    <h2 class="text-2xl font-bold mb-4">¬°Has terminado!</h2>
                    
                    <div id="student-stats-card" class="bg-slate-50 border border-slate-200 rounded-lg p-6 text-left shadow-sm mb-4">
                        <div class="flex items-center pb-4 mb-4 border-b">
                            <span id="stats-emoji" class="text-5xl mr-4"></span>
                            <div>
                                <h3 id="stats-name" class="text-xl font-bold text-slate-800"></h3>
                                <p class="text-sm text-slate-500">Tu resumen de rendimiento</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div id="stats-hearts-container" class="flex items-center"><span class="text-2xl mr-2">‚ù§Ô∏è</span><span id="stats-hearts"></span></div>
                            <div id="stats-score-container" class="flex items-center"><span class="text-2xl mr-2">üèÜ</span><span id="stats-score"></span></div>
                            <div id="stats-correct-container" class="flex items-center"><span class="text-2xl mr-2">‚úÖ</span><span id="stats-correct"></span></div>
                            <div id="stats-incorrect-container" class="flex items-center"><span class="text-2xl mr-2">‚ùå</span><span id="stats-incorrect"></span></div>
                            <div class="col-span-2 flex items-center"><span class="text-2xl mr-2">‚è±Ô∏è</span><span id="stats-time"></span></div>
                        </div>
                    </div>
                    <p class="text-slate-600 font-semibold bg-yellow-100 border border-yellow-300 rounded-lg p-3">
                        Por favor, no cierres esta ventana. Espera a que el profesor finalice el examen para ver el ranking general.
                    </p>
                </div>
                <div id="results-view" class="hidden w-full h-full flex flex-col">
                    <header id="podium-view" class="mb-6 flex-shrink-0">
                        <div id="podium-emoji" class="text-7xl mb-2"></div>
                        <h2 id="podium-title" class="text-2xl font-bold"></h2>
                        <p id="podium-message" class="text-slate-600"></p>
                    </header>
                    <div class="scrollable-content flex-grow border rounded-lg">
                        <h3 id="final-ranking-title" class="text-xl font-bold my-2 sticky top-0 bg-white py-2 z-10">Ranking Final</h3>
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-100 sticky top-0 z-10">
                                <tr id="final-ranking-header"></tr>
                            </thead>
                            <tbody id="final-ranking-table-body"></tbody>
                        </table>
                    </div>
                    <button id="go-home-btn" class="w-full mt-4 bg-amber-500 text-white font-bold py-3 rounded-lg hover:bg-amber-600 transition-colors flex-shrink-0">Volver al Inicio</button>
                </div>
            </section>
        </div>
    </main>

    <!-- Modal de Confirmaci√≥n de Respuesta -->
    <div id="answer-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-20" role="dialog" aria-modal="true" aria-labelledby="answer-confirm-title">
        <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full text-center">
            <h2 id="answer-confirm-title" class="sr-only">Confirmar Respuesta</h2>
            <p class="mb-4 font-medium">¬øEst√°s seguro de tu respuesta?</p>
            <div class="flex justify-center space-x-4">
                <button id="answer-cancel-btn" class="px-6 py-2 rounded-lg bg-slate-200 hover:bg-slate-300 font-semibold">Cancelar</button>
                <button id="answer-ok-btn" class="px-6 py-2 rounded-lg bg-green-500 text-white hover:bg-green-600 font-bold">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Penalizaci√≥n -->
    <div id="penalty-screen" class="hidden fixed inset-0 bg-red-900 bg-opacity-90 flex items-center justify-center text-white text-center p-4 z-50" role="alertdialog" aria-modal="true" aria-labelledby="penalty-title">
        <div>
            <p class="text-4xl mb-4" aria-hidden="true">‚è±Ô∏è</p>
            <h2 id="penalty-title" class="text-2xl font-bold mb-2">¬°Tiempo Fuera!</h2>
            <p class="mb-4">Espera para continuar...</p>
            <p id="penalty-countdown" class="text-6xl font-bold">20</p>
        </div>
    </div>

    <!-- Elementos de Audio -->
    <audio id="sound-hover" src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"></audio>
    <audio id="sound-click" src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YUAAAAAAAAAAAAAAAAAAAAA"></audio>
    <audio id="sound-select" src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YUAAAAAAAAAAAAAAAAAAAAA"></audio>
    <audio id="sound-correct" src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YUAAAAAAAAAAAAAAAAAAAAA"></audio>
    <audio id="sound-incorrect" src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YUAAAAAAAAAAAAAAAAAAAAA"></audio>
    <audio id="sound-keypress" src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"></audio>

    <!-- Firebase SDK y Scripts de la Aplicaci√≥n -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="js/config.js" type="module"></script>
    <script src="js/sounds.js" type="module"></script>
    <script src="js/ui.js" type="module"></script>
    <script src="js/student.js" type="module"></script>
</body>
</html>

